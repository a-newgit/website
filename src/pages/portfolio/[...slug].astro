---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import Prose from "../../components/Prose.astro";
import { getCollection, render } from "astro:content";
import { verifyAuth } from "../../lib/auth";

export const prerender = false;

export async function getStaticPaths() {
  const caseStudies = await getCollection("case-studies");
  return caseStudies.map((study) => ({
    params: { slug: study.id },
    props: { study },
  }));
}

const token = Astro.cookies.get("portfolio_auth")?.value;
const isAuthenticated = await verifyAuth(token);

if (!isAuthenticated) {
  return Astro.redirect("/portfolio/login");
}

const { slug } = Astro.params;
const caseStudies = await getCollection("case-studies");
const study = caseStudies.find((s) => s.id === slug);

if (!study) {
  return Astro.redirect("/portfolio");
}

const { Content } = await render(study);
---

<BaseLayout title={study.data.title} description={study.data.summary}>
  <Header />
  <main class="case-study">
    <header class="study-header container">
      <div class="study-meta">
        {study.data.client && <span class="meta-item">{study.data.client}</span>}
        <span class="meta-item">{study.data.role}</span>
        <span class="meta-item">{study.data.year}</span>
        {study.data.duration && <span class="meta-item">{study.data.duration}</span>}
      </div>
      <h1 class="study-title">{study.data.title}</h1>
      {study.data.subtitle && <p class="study-subtitle">{study.data.subtitle}</p>}
      <p class="study-summary">{study.data.summary}</p>

      <div class="study-details">
        {
          study.data.team && (
            <div class="detail">
              <span class="detail-label">Team</span>
              <span class="detail-value">{study.data.team}</span>
            </div>
          )
        }
        {
          study.data.platform && (
            <div class="detail">
              <span class="detail-label">Platform</span>
              <span class="detail-value">{study.data.platform}</span>
            </div>
          )
        }
        {
          study.data.tools && study.data.tools.length > 0 && (
            <div class="detail">
              <span class="detail-label">Tools</span>
              <span class="detail-value">{study.data.tools.join(", ")}</span>
            </div>
          )
        }
      </div>
    </header>

    <article class="study-content container">
      <Prose>
        <Content />
      </Prose>
    </article>

    <footer class="study-footer container">
      <a href="/portfolio" class="back-link">&larr; Back to portfolio</a>
    </footer>
  </main>
  <Footer />
</BaseLayout>

<style>
  .case-study {
    padding-bottom: var(--space-16);
  }

  .study-header {
    padding-top: var(--space-12);
    padding-bottom: var(--space-12);
    border-bottom: 1px solid var(--color-border-subtle);
    max-width: var(--content-width);
    margin: 0 auto;
  }

  .study-meta {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-4);
    margin-bottom: var(--space-4);
  }

  .meta-item {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
  }

  .meta-item:not(:last-child)::after {
    content: "Â·";
    margin-left: var(--space-4);
  }

  .study-title {
    font-size: var(--text-4xl);
    line-height: 1.2;
    margin-bottom: var(--space-4);
  }

  .study-subtitle {
    font-size: var(--text-xl);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-4);
  }

  .study-summary {
    font-size: var(--text-lg);
    color: var(--color-text-secondary);
    line-height: 1.7;
    margin-bottom: var(--space-8);
  }

  .study-details {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-6);
    padding-top: var(--space-6);
    border-top: 1px solid var(--color-border-subtle);
  }

  .detail {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  .detail-label {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-muted);
  }

  .detail-value {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
  }

  .study-content {
    padding-top: var(--space-12);
    max-width: var(--content-width);
    margin: 0 auto;
  }

  .study-footer {
    margin-top: var(--space-12);
    padding-top: var(--space-6);
    border-top: 1px solid var(--color-border-subtle);
    max-width: var(--content-width);
    margin-left: auto;
    margin-right: auto;
  }

  .back-link {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    text-decoration: none;
  }

  .back-link:hover {
    color: var(--color-text);
  }
</style>
